# Sea Salt & Paper - 遊戲規則完整規格書 (Game Rules Specification)

**版本**: 1.0.0
**最後更新**: 2025-12-13
**文件類型**: Software Design Document - Game Rules

---

## 目錄

1. [遊戲概述](#1-遊戲概述)
2. [卡牌系統](#2-卡牌系統)
3. [遊戲設置](#3-遊戲設置)
4. [回合流程](#4-回合流程)
5. [配對系統](#5-配對系統)
6. [得分計算](#6-得分計算)
7. [宣告系統](#7-宣告系統)
8. [回合結算](#8-回合結算)
9. [勝利條件](#9-勝利條件)
10. [特殊規則](#10-特殊規則)

---

## 1. 遊戲概述

### 1.1 遊戲名稱
Sea Salt & Paper（海鹽與紙牌）

### 1.2 遊戲類型
- 多人卡牌收集遊戲
- 支援 2-4 人
- 回合制策略遊戲

### 1.3 遊戲目標
玩家透過收集、配對和策略性宣告來獲得分數。第一個達到目標分數或集齊特定條件的玩家獲勝。

### 1.4 核心機制
- **抽牌選擇**: 玩家可從牌庫或棄牌堆抽牌
- **配對效果**: 特定卡牌配對會觸發效果
- **策略宣告**: 玩家可選擇停止或給予對手最後機會
- **顏色收集**: 美人魚卡根據顏色分布計分

---

## 2. 卡牌系統

### 2.1 標準牌組構成（共 72 張）

#### 2.1.1 配對效果卡 (Pair Effect Cards) - 34 張

| 卡牌名稱 | 數量 | 符號 | 配對效果 | 基礎分數 |
|---------|------|------|---------|---------|
| Fish (魚) | 7 | 🐟 | draw_blind | 0 |
| Crab (螃蟹) | 9 | 🦀 | draw_discard | 0 |
| Sailboat (帆船) | 8 | ⛵ | extra_turn | 0 |
| Shark (鯊魚) | 5 | 🦈 | steal_card* | 0 |
| Swimmer (游泳者) | 5 | 🏊 | steal_card* | 0 |

**註**: Shark 和 Swimmer 必須互相配對才能觸發偷牌效果

#### 2.1.2 收集卡 (Collection Cards) - 21 張

| 卡牌名稱 | 數量 | 符號 | 計分公式 | 基礎分數 |
|---------|------|------|---------|---------|
| Shell (貝殼) | 6 | 🐚 | (count-1)×2 | 0 |
| Octopus (章魚) | 5 | 🐙 | (count-1)×3 | 0 |
| Penguin (企鵝) | 3 | 🐧 | count×2-1 | 0 |
| Sailor (水手) | 2 | 👨‍🌾 | count≥2 ? 5 : 0 | 0 |
| Starfish (海星) | 5 | ⭐ | (count-1)×2 | 0 |

**計分範例**:
```
3 張 Shell: (3-1)×2 = 4 分
3 張 Octopus: (3-1)×3 = 6 分
3 張 Penguin: 3×2-1 = 5 分
2 張 Sailor: 5 分
1 張 Sailor: 0 分
```

#### 2.1.3 倍數卡 (Multiplier Cards) - 5 張

| 卡牌名稱 | 數量 | 符號 | 目標 | 加成公式 | 基礎分數 |
|---------|------|------|------|---------|---------|
| Lighthouse (燈塔) | 1 | 🗼 | Sailboat | sailboat_count×1 | 0 |
| Fish School (魚群) | 1 | 🐟🐟 | Fish | fish_count×1 | 0 |
| Penguin Colony (企鵝部落) | 1 | 🐧👥 | Penguin | penguin_count×2 | 0 |
| Captain (船長) | 1 | 👨‍✈️ | Sailor | sailor_count×3 | 0 |
| Seagull (海鷗) | 1 | 🦅 | Starfish | starfish_count×1 | 0 |

**加成範例**:
```
手牌: 5 張 Sailboat + 1 張 Lighthouse
Sailboat 得分: floor(5/2)×1 = 2 分（配對獎勵）
Lighthouse 加成: 5×1 = 5 分
總計: 7 分
```

#### 2.1.4 特殊卡 (Special Cards) - 4 張

| 卡牌名稱 | 數量 | 符號 | 特殊規則 | 基礎分數 |
|---------|------|------|---------|---------|
| Mermaid (美人魚) | 4 | 🧜 | 顏色計分 | 0 |

**美人魚計分規則**（詳見 6.5）:
- 第 1 張美人魚 = 最多顏色的卡片數量
- 第 2 張美人魚 = 第二多顏色的卡片數量
- 第 3 張美人魚 = 第三多顏色的卡片數量
- **4 張美人魚 = 直接獲勝！**

### 2.2 卡牌屬性結構

每張卡牌包含以下屬性：

```javascript
{
  id: string,              // 唯一識別碼，格式: "卡牌名_編號" (e.g., "fish_1")
  name: string,            // 卡牌名稱 (e.g., "Fish")
  type: string,            // 卡牌類型: "pair_effect" | "collection" | "multiplier" | "special"
  emoji: string,           // 圖示符號 (e.g., "🐟")
  color: string,           // 顏色: "blue" | "red" | "green" | "yellow" | "purple" | "black" | "white"
  value: number,           // 基礎點數（通常為 0）
  pairEffect: string|null, // 配對效果: "draw_blind" | "draw_discard" | "extra_turn" | "steal_card" | null
  description: string,     // 卡牌描述

  // 倍數卡專用
  multiplierTarget: string|string[]|null,  // 目標卡牌類型
  multiplierValue: number|null             // 加成數值
}
```

### 2.3 顏色分配系統

#### 2.3.1 可用顏色

| 顏色代碼 | 中文名稱 | Hex 色碼 | 符號 | 特殊限制 |
|---------|---------|---------|------|---------|
| blue | 藍色 | #3B82F6 | 🔵 | - |
| red | 紅色 | #EF4444 | 🔴 | - |
| green | 綠色 | #22C55E | 🟢 | - |
| yellow | 黃色 | #EAB308 | 🟡 | - |
| purple | 紫色 | #A855F7 | 🟣 | - |
| black | 黑色 | #374151 | ⚫ | - |
| white | 白色 | #F8FAFC | ⚪ | **僅限美人魚** |

#### 2.3.2 顏色分配規則

**標準分配** (當前實作):
```
藍色: 10 張
紅色: 10 張
綠色: 10 張
黃色: 10 張
紫色: 10 張
黑色: 8 張
白色: 4 張（僅美人魚）
────────────
總計: 62 張
```

**分配流程**:
1. 建立顏色池：按照上述分配創建顏色陣列
2. 使用 Fisher-Yates 演算法洗亂顏色池
3. 依序為每張卡牌分配顏色
4. **例外**: 美人魚 (Mermaid) 固定分配白色

**實作演算法**:
```javascript
function assignRandomColors(cards) {
  // 1. 建立顏色池
  const colorPool = createColorPool() // ['blue', 'blue', ..., 'red', 'red', ...]

  // 2. 洗亂
  const shuffledPool = shuffleArray(colorPool)

  // 3. 分配
  let colorIndex = 0
  return cards.map(card => {
    if (card.name === 'Mermaid') {
      return { ...card, color: 'white' }
    }
    const color = shuffledPool[colorIndex++]
    return { ...card, color }
  })
}
```

---

## 3. 遊戲設置

### 3.1 玩家人數與目標分數

| 玩家數 | 預設目標分數 |
|-------|------------|
| 2 人 | 40 分 |
| 3 人 | 35 分 |
| 4 人 | 30 分 |

**可自訂選項**:
- 房主可設定自訂目標分數（範圍: 10-100 分）
- 設定為 "auto" 則根據玩家數自動計算

### 3.2 初始設置步驟

#### 步驟 1: 牌庫準備
1. 取出所有 72 張卡牌
2. 為每張卡牌分配隨機顏色（除美人魚外）
3. 洗亂牌庫

#### 步驟 2: 發牌
1. **標準規則**: 玩家初始手牌為 0 張
2. **可選變體**: 可設定起始手牌數（通常為 0 或 2 張）

#### 步驟 3: 棄牌堆
1. 建立兩個空的棄牌堆：**左棄牌堆** 和 **右棄牌堆**
2. 初始時兩個棄牌堆都為空

#### 步驟 4: 決定起始玩家
1. 隨機選擇一名玩家作為起始玩家
2. 在該玩家座位顯示「起始玩家」標記 ⭐

---

## 4. 回合流程

### 4.1 回合階段狀態機

```
┌─────────────────────────────────────────────┐
│                                             │
│  DRAW PHASE (抽牌階段)                       │
│  ↓                                          │
│  PAIR PHASE (配對階段)                       │
│  ↓                                          │
│  DECLARE PHASE (宣告階段)                    │
│  ↓                                          │
│  DECLARE_SHOWING (顯示宣告)                  │
│  ↓                                          │
│  ROUND_END (回合結算)                        │
│  ↓                                          │
│  (重置，下一位玩家) ─────────────────────┘   │
└─────────────────────────────────────────────┘
```

### 4.2 詳細階段說明

#### 4.2.1 DRAW PHASE (抽牌階段)

**可執行動作**:
1. 從牌庫抽 1 張牌
2. 從左棄牌堆拿取最上方的牌
3. 從右棄牌堆拿取最上方的牌

**規則**:
- **必須抽牌**: 玩家必須選擇其中一種方式獲得 1 張牌
- **只能抽1張**: 不可跳過或抽取多張
- **棄牌堆規則**:
  - 只能拿取棄牌堆最上方（最新）的牌
  - 棄牌堆為空時無法拿取

**從牌庫抽牌流程**:
1. 玩家點擊牌庫
2. 系統從牌庫抽取 1 張牌
3. 顯示抽到的卡牌（翻牌動畫）
4. 玩家**必須**將抽到的牌棄到左或右棄牌堆
5. 該牌加入玩家手牌

**從棄牌堆拿牌流程**:
1. 玩家點擊左或右棄牌堆
2. 該棄牌堆的最上方卡牌直接加入玩家手牌
3. 該卡從棄牌堆移除

**牌庫空了怎麼辦？**
- 保留兩個棄牌堆的最上方卡牌
- 將其餘棄牌洗亂成新牌庫
- 如果沒有足夠卡牌，牌庫維持為空（玩家無法從牌庫抽牌）

#### 4.2.2 PAIR PHASE (配對階段)

**可執行動作**:
1. 選擇手牌中的 2 張卡牌進行配對
2. 打出配對（觸發效果）
3. 重複步驟 1-2（可打出多對）
4. 結束配對，進入宣告階段

**配對規則** (詳見第 5 章):
- 兩張同名的配對效果卡可以配對
- Shark + Swimmer 可以互相配對（特殊規則）
- 其他卡牌組合無法配對

**配對後**:
- 該對卡牌從手牌移至「已打出對子」區域
- 觸發對應的配對效果（如有）
- 配對效果執行完畢後，玩家可選擇繼續配對或結束

**結束配對**:
- 玩家點擊「結束配對」按鈕
- 進入宣告階段

#### 4.2.3 DECLARE PHASE (宣告階段)

**可執行動作**:
1. 宣告「停止」(Stop)
2. 宣告「最後機會」(Last Chance)

**宣告選項詳細說明**:

**選項 1: 停止 (Stop)**
- **效果**: 立即結束回合
- **計分**:
  - 所有玩家計算手牌和已打出對子的分數
  - **不計算**顏色加成
  - 直接進入回合結算

**選項 2: 最後機會 (Last Chance)**
- **效果**: 給予其他玩家最後一次機會
- **流程**:
  1. 宣告者的回合結束
  2. 其他玩家依序進行**一次完整回合**（抽牌→配對→宣告）
  3. 所有玩家完成後進入回合結算
- **計分**: 複雜規則（詳見 7.2）

#### 4.2.4 DECLARE_SHOWING (顯示宣告)

**目的**: 向所有玩家展示宣告者的分數和選擇

**顯示內容**:
- 宣告者名稱
- 宣告模式（Stop 或 Last Chance）
- 宣告時的分數

**持續時間**: 3 秒

**過渡**: 自動進入 ROUND_END

#### 4.2.5 ROUND_END (回合結算)

**執行內容**:
1. 計算所有玩家的分數（根據宣告模式）
2. 更新累積分數
3. 檢查勝利條件
4. 顯示回合結算動畫
5. 重置遊戲狀態
6. 進入下一回合

**詳細流程** (詳見第 8 章)

---

## 5. 配對系統

### 5.1 有效配對組合

#### 5.1.1 標準配對

**規則**: 兩張**同名**的配對效果卡可以配對

**有效組合**:
```
Fish + Fish       ✓
Crab + Crab       ✓
Sailboat + Sailboat ✓
Shark + Shark     ✓
Swimmer + Swimmer ✓
```

**無效組合**:
```
Fish + Crab       ✗
Shell + Shell     ✗ (不是配對效果卡)
Octopus + Octopus ✗ (不是配對效果卡)
```

#### 5.1.2 特殊配對

**Shark + Swimmer 互相配對**:
```
Shark + Swimmer   ✓
Swimmer + Shark   ✓
```

### 5.2 配對效果觸發

#### 5.2.1 Fish + Fish → 抽牌 (draw_blind)

**效果**: 從牌庫抽 1 張牌

**流程**:
1. 玩家打出 Fish + Fish
2. 系統從牌庫抽取 1 張牌
3. 顯示抽到的牌（翻牌動畫）
4. 玩家**必須**將該牌棄到左或右棄牌堆
5. 該牌加入玩家手牌
6. 效果結束，玩家可繼續配對

**特殊情況**:
- 如果牌庫為空，效果無法觸發（配對仍然有效，但無抽牌效果）

#### 5.2.2 Crab + Crab → 從棄牌堆拿牌 (draw_discard)

**效果**: 從左或右棄牌堆拿取 1 張牌

**流程**:
1. 玩家打出 Crab + Crab
2. 顯示棄牌堆選擇模態框
3. 玩家選擇左或右棄牌堆
4. 該棄牌堆的最上方卡牌加入玩家手牌
5. 該卡從棄牌堆移除
6. 效果結束，玩家可繼續配對

**特殊情況**:
- 如果兩個棄牌堆都為空，效果無法觸發
- 如果只有一個棄牌堆有牌，玩家只能選擇該堆

#### 5.2.3 Sailboat + Sailboat → 額外回合 (extra_turn)

**效果**: 當前玩家獲得額外回合

**流程**:
1. 玩家打出 Sailboat + Sailboat
2. 系統標記「額外回合」狀態
3. 當玩家宣告後，**不**轉移到下一位玩家
4. 同一玩家再次進入抽牌階段

**重要規則**:
- 額外回合可以累積（打出 2 對 Sailboat = 2 次額外回合）
- 額外回合期間，玩家可以再次打出 Sailboat 配對
- **無限循環保護**: 實作上可限制單次回合最多 5 次額外回合

#### 5.2.4 Shark + Swimmer → 偷牌 (steal_card)

**效果**: 從對手手中隨機偷取 1 張牌

**流程**:
1. 玩家打出 Shark + Swimmer（或 Swimmer + Shark）
2. 顯示對手選擇模態框（列出所有其他玩家）
3. 玩家選擇目標對手
4. 系統從目標對手手牌中隨機選擇 1 張牌
5. 該牌從對手手牌移至當前玩家手牌
6. 在目標對手座位顯示「⚠️ 被偷牌」標記（3 秒後消失）
7. 效果結束，玩家可繼續配對

**特殊情況**:
- 如果目標對手沒有手牌，無法偷牌（但可選擇其他對手）
- 如果所有對手都沒有手牌，效果無法觸發

**偷牌記錄**:
- 被偷的牌會記錄在「已打出對子」中
- 顯示為「偷得: [卡牌名稱]」

### 5.3 配對計分

**基本規則**: 每對配對卡 = +1 分

**計算公式**:
```
配對獎勵 = floor(同名配對卡數量 / 2) × 1

範例:
2 張 Fish → 1 對 → +1 分
3 張 Fish → 1 對 → +1 分（剩餘1張不計分）
4 張 Fish → 2 對 → +2 分
5 張 Fish → 2 對 → +2 分（剩餘1張不計分）
```

**已打出的對子**:
- 已打出的對子也計入配對獎勵
- 例如：打出 2 對 Fish（4 張），得分 +2

---

## 6. 得分計算

### 6.1 總分公式

```
總得分 = 基礎分數 + 配對獎勵 + 倍數加成 + 美人魚分數 + 顏色加成(可選)
```

### 6.2 基礎分數計算

**計算範圍**: 手牌 + 已打出的對子中的所有卡牌

#### 6.2.1 Shell (貝殼)

**公式**: `(count - 1) × 2`

**範例**:
```
1 張 Shell: (1-1)×2 = 0 分
2 張 Shell: (2-1)×2 = 2 分
3 張 Shell: (3-1)×2 = 4 分
4 張 Shell: (4-1)×2 = 6 分
6 張 Shell: (6-1)×2 = 10 分
```

#### 6.2.2 Octopus (章魚)

**公式**: `(count - 1) × 3`

**範例**:
```
1 張 Octopus: (1-1)×3 = 0 分
2 張 Octopus: (2-1)×3 = 3 分
3 張 Octopus: (3-1)×3 = 6 分
5 張 Octopus: (5-1)×3 = 12 分
```

#### 6.2.3 Penguin (企鵝)

**公式**: `count × 2 - 1`

**範例**:
```
1 張 Penguin: 1×2-1 = 1 分
2 張 Penguin: 2×2-1 = 3 分
3 張 Penguin: 3×2-1 = 5 分
```

#### 6.2.4 Sailor (水手)

**公式**: `count >= 2 ? 5 : 0`

**範例**:
```
0 張 Sailor: 0 分
1 張 Sailor: 0 分
2 張 Sailor: 5 分
3 張 Sailor: 5 分（不增加）
```

**重要**: Sailor 的得分不會隨數量增加而增加，只要有 2 張即得 5 分。

#### 6.2.5 Starfish (海星)

**公式**: `(count - 1) × 2`（與 Shell 相同）

**範例**:
```
1 張 Starfish: (1-1)×2 = 0 分
2 張 Starfish: (2-1)×2 = 2 分
5 張 Starfish: (5-1)×2 = 8 分
```

#### 6.2.6 配對效果卡 (Fish, Crab, Sailboat, Shark, Swimmer)

**公式**: `floor(count / 2) × 1`

**範例**:
```
1 張 Fish: floor(1/2)×1 = 0 分
2 張 Fish: floor(2/2)×1 = 1 分
3 張 Fish: floor(3/2)×1 = 1 分
4 張 Fish: floor(4/2)×1 = 2 分
7 張 Fish: floor(7/2)×1 = 3 分
```

**重要**:
- 只有**配對**的卡牌才計分
- 單張配對卡不計分
- 已打出的對子也計入（與手牌中的相同卡牌不重複計算）

### 6.3 配對獎勵

**公式**: `已打出的對子數量 × 1`

**範例**:
```
打出 2 對 Fish: 2 分
打出 1 對 Crab + 1 對 Sailboat: 2 分
打出 3 對 Shark: 3 分
```

**與基礎分數的關係**:
- 配對獎勵**獨立於**基礎分數
- 已打出的對子**同時**計入基礎分數和配對獎勵

**完整範例**:
```
手牌: 2 張 Fish（未配對）
已打出對子: 1 對 Fish

基礎分數:
  - 手牌 2 張 + 已打出 2 張 = 4 張 Fish
  - floor(4/2)×1 = 2 分

配對獎勵:
  - 1 對 = 1 分

總計: 2 + 1 = 3 分
```

### 6.4 倍數加成

#### 6.4.1 Lighthouse (燈塔)

**目標**: Sailboat (帆船)
**公式**: `sailboat_count × 1`

**範例**:
```
手牌: 5 張 Sailboat + 1 張 Lighthouse
Sailboat 基礎分: floor(5/2)×1 = 2 分
Lighthouse 加成: 5×1 = 5 分
總計: 2 + 5 = 7 分
```

#### 6.4.2 Fish School (魚群)

**目標**: Fish (魚)
**公式**: `fish_count × 1`

**範例**:
```
手牌: 7 張 Fish + 1 張 Fish School
Fish 基礎分: floor(7/2)×1 = 3 分
Fish School 加成: 7×1 = 7 分
總計: 3 + 7 = 10 分
```

#### 6.4.3 Penguin Colony (企鵝部落)

**目標**: Penguin (企鵝)
**公式**: `penguin_count × 2`

**範例**:
```
手牌: 3 張 Penguin + 1 張 Penguin Colony
Penguin 基礎分: 3×2-1 = 5 分
Penguin Colony 加成: 3×2 = 6 分
總計: 5 + 6 = 11 分
```

#### 6.4.4 Captain (船長)

**目標**: Sailor (水手)
**公式**: `sailor_count × 3`

**範例**:
```
手牌: 2 張 Sailor + 1 張 Captain
Sailor 基礎分: 5 分
Captain 加成: 2×3 = 6 分
總計: 5 + 6 = 11 分
```

#### 6.4.5 Seagull (海鷗)

**目標**: Starfish (海星)
**公式**: `starfish_count × 1`

**範例**:
```
手牌: 5 張 Starfish + 1 張 Seagull
Starfish 基礎分: (5-1)×2 = 8 分
Seagull 加成: 5×1 = 5 分
總計: 8 + 5 = 13 分
```

### 6.5 美人魚分數 (Mermaid Scoring)

**規則**: 美人魚根據手牌中**非美人魚卡牌**的顏色分布計分

#### 6.5.1 計分流程

1. **統計顏色**: 計算所有非美人魚卡牌的顏色數量
2. **排序**: 按顏色數量從多到少排序
3. **美人魚計分**:
   - 第 1 張美人魚 = 最多顏色的卡片數量
   - 第 2 張美人魚 = 第二多顏色的卡片數量
   - 第 3 張美人魚 = 第三多顏色的卡片數量
   - 第 4 張美人魚 = **直接獲勝！**

#### 6.5.2 詳細範例

**範例 1: 基本計分**
```
手牌:
- 3 張藍色卡 (🐟🐟🐟)
- 2 張紅色卡 (🦀🦀)
- 1 張綠色卡 (⛵)
- 2 張美人魚 (🧜🧜)

顏色統計（不含美人魚）:
- 藍色: 3 張
- 紅色: 2 張
- 綠色: 1 張

美人魚得分:
- 第 1 張美人魚: 3 分（最多顏色 = 藍色 3 張）
- 第 2 張美人魚: 2 分（次多顏色 = 紅色 2 張）
- 總計: 5 分
```

**範例 2: 多張美人魚**
```
手牌:
- 5 張藍色卡
- 4 張紅色卡
- 3 張綠色卡
- 2 張黃色卡
- 3 張美人魚

顏色統計:
- 藍色: 5 張
- 紅色: 4 張
- 綠色: 3 張
- 黃色: 2 張

美人魚得分:
- 第 1 張: 5 分（藍色）
- 第 2 張: 4 分（紅色）
- 第 3 張: 3 分（綠色）
- 總計: 12 分
```

**範例 3: 顏色不足**
```
手牌:
- 6 張藍色卡
- 3 張美人魚

顏色統計:
- 藍色: 6 張

美人魚得分:
- 第 1 張: 6 分（藍色）
- 第 2 張: 0 分（沒有第二種顏色）
- 第 3 張: 0 分（沒有第三種顏色）
- 總計: 6 分
```

**範例 4: 即刻獲勝**
```
手牌:
- 任意卡牌
- 4 張美人魚 🧜🧜🧜🧜

結果: **立即獲勝！** 不需要計算分數。
```

#### 6.5.3 特殊情況

**Q: 美人魚本身的顏色計算嗎？**
A: **不計算**。美人魚的白色**不**計入顏色統計。

**Q: 已打出對子中的卡牌計算嗎？**
A: **計算**。所有手牌和已打出對子中的非美人魚卡牌都計入顏色統計。

**Q: 如果有多種顏色數量相同怎麼辦？**
A: 按照顏色代碼的字母順序排序（black < blue < green < purple < red < yellow）。

### 6.6 顏色加成 (Color Bonus)

**觸發條件**: 僅在特定宣告模式下計算

**公式**: `最多顏色的卡片數量`

**範例**:
```
手牌:
- 5 張藍色卡
- 3 張紅色卡
- 2 張綠色卡

顏色加成: 5 分（藍色最多）
```

**重要**:
- **Stop 模式**: 不計算顏色加成
- **Last Chance 模式**: 根據複雜規則計算（詳見 7.2）

### 6.7 完整計分範例

**場景**: Alice 宣告停止

**Alice 的卡牌**:
```
手牌:
- 3 張 Shell (藍、紅、綠)
- 2 張 Octopus (藍、紅)
- 1 張 Lighthouse (黃)
- 2 張 Sailboat (綠、黃)
- 2 張 Mermaid (白、白)

已打出對子:
- 1 對 Sailboat (綠、黃)
```

**計算過程**:

1. **基礎分數**:
   - Shell: (3-1)×2 = 4 分
   - Octopus: (2-1)×3 = 3 分
   - Sailboat: floor(4/2)×1 = 2 分（手牌2張 + 已打出2張）
   - **小計**: 9 分

2. **配對獎勵**:
   - 1 對 Sailboat = 1 分

3. **倍數加成**:
   - Lighthouse: 4×1 = 4 分（4 張 Sailboat）

4. **美人魚分數**:
   - 顏色統計（不含美人魚）:
     - 藍色: 2 張（1 Shell + 1 Octopus）
     - 紅色: 2 張（1 Shell + 1 Octopus）
     - 綠色: 3 張（1 Shell + 2 Sailboat + 1 對 Sailboat）
     - 黃色: 3 張（1 Lighthouse + 1 Sailboat + 1 對 Sailboat）
   - 排序: 綠色=3, 黃色=3, 藍色=2, 紅色=2
   - 第 1 張美人魚: 3 分（綠色，按字母順序優先）
   - 第 2 張美人魚: 3 分（黃色）
   - **小計**: 6 分

5. **顏色加成**:
   - Stop 模式 → 0 分

**總計**: 9 + 1 + 4 + 6 + 0 = **20 分**

---

## 7. 宣告系統

### 7.1 Stop 模式

#### 7.1.1 效果
- 立即結束回合
- 所有玩家計算分數
- **不計算顏色加成**

#### 7.1.2 計分規則

**所有玩家**:
```
玩家得分 = 基礎分數 + 配對獎勵 + 倍數加成 + 美人魚分數
```

**範例**:
```
Alice 宣告 Stop，得分 20 分
Bob 得分 15 分
Carol 得分 18 分
David 得分 12 分

回合結束，所有玩家累積分數增加對應數值
```

#### 7.1.3 適用場景
- 自己分數領先，不想給對手機會
- 確保穩定得分
- 避免對手超越

### 7.2 Last Chance 模式

#### 7.2.1 效果
- 給予其他玩家最後一次完整回合
- 複雜的計分規則

#### 7.2.2 流程

1. **Alice 宣告 Last Chance**，回合結束
2. **Bob 進行完整回合**（抽牌 → 配對 → 宣告）
3. **Carol 進行完整回合**
4. **David 進行完整回合**
5. **所有玩家完成後，計算分數**

#### 7.2.3 計分規則

**判斷條件**: 宣告者的分數是否為最高或並列最高

**情況 1: 宣告者分數最高或並列最高**
```
宣告者得分 = 卡片分數 + 顏色加成
其他玩家得分 = 顏色加成（僅顏色加成，不計卡片分數）
```

**範例**:
```
Alice (宣告者): 卡片分數 25 分，顏色加成 5 分 → 總計 30 分
Bob: 卡片分數 28 分，顏色加成 6 分 → 總計 6 分（僅顏色加成）
Carol: 卡片分數 22 分，顏色加成 4 分 → 總計 4 分（僅顏色加成）
```

**情況 2: 宣告者分數不是最高**
```
宣告者得分 = 顏色加成（僅顏色加成，不計卡片分數）
其他玩家得分 = 卡片分數 + 顏色加成
```

**範例**:
```
Alice (宣告者): 卡片分數 20 分，顏色加成 5 分 → 總計 5 分（僅顏色加成）
Bob: 卡片分數 28 分，顏色加成 6 分 → 總計 34 分
Carol: 卡片分數 22 分，顏色加成 4 分 → 總計 26 分
```

#### 7.2.4 策略考量

**何時使用 Last Chance**:
- 自己分數非常高，有信心保持領先
- 想要獲得顏色加成
- 阻止對手獲得完整分數

**風險**:
- 對手可能超越自己
- 如果被超越，自己只得顏色加成

---

## 8. 回合結算

### 8.1 結算流程

#### 步驟 1: 計算分數
- 根據宣告模式（Stop 或 Last Chance）計算所有玩家分數
- 套用對應的計分規則

#### 步驟 2: 更新累積分數
```
新累積分數 = 原累積分數 + 本回合得分
```

#### 步驟 3: 檢查勝利條件
- 檢查是否有玩家達到目標分數
- 檢查是否有玩家集齊 4 張美人魚
- 如果有，該玩家獲勝，遊戲結束

#### 步驟 4: 顯示結算動畫
- 顯示所有玩家的本回合得分
- 顯示累積分數變化
- 動畫持續約 5 秒

#### 步驟 5: 重置遊戲狀態
- 清空所有玩家的手牌
- 清空已打出的對子
- 重新洗牌並發牌（如有起始手牌設定）
- 清空兩個棄牌堆
- 重置牌庫

#### 步驟 6: 進入下一回合
- 當前玩家切換至下一位玩家
- 回合計數器 +1
- 進入抽牌階段

### 8.2 結算資料結構

```javascript
{
  roundNumber: number,
  declaringPlayer: {
    id: string,
    name: string,
    declareMode: "stop" | "last_chance"
  },
  scores: {
    [playerId]: {
      cardScore: number,
      colorBonus: number,
      roundTotal: number,
      cumulativeScore: number
    }
  },
  winner: string | null
}
```

---

## 9. 勝利條件

### 9.1 分數勝利

**條件**: 玩家的累積分數達到或超過目標分數

**判定時機**: 每回合結算後

**範例**:
```
目標分數: 30 分
Alice 累積分數: 32 分 → Alice 獲勝！
```

### 9.2 美人魚勝利

**條件**: 玩家集齊 4 張美人魚

**判定時機**:
- 每次抽牌後
- 每次配對效果觸發後
- 回合結算前

**範例**:
```
Alice 手牌中有 4 張美人魚 → Alice 立即獲勝！
```

**重要**: 美人魚勝利**優先於**分數勝利

### 9.3 平手處理

**情況**: 多位玩家同時達到目標分數

**規則**: **分數最高者**獲勝

**範例**:
```
目標分數: 30 分
Alice: 32 分
Bob: 35 分
→ Bob 獲勝（分數更高）
```

**完全平手**: 分數完全相同時，**宣告者**獲勝

---

## 10. 特殊規則

### 10.1 棄牌堆規則

#### 10.1.1 基本規則
- 有兩個棄牌堆：左和右
- 玩家可以將牌棄到任一棄牌堆

#### 10.1.2 空堆規則

**規則**: 如果有一個棄牌堆為空，玩家**必須**將牌棄到空的那一堆

**範例**:
```
左棄牌堆: 空
右棄牌堆: [🐟, 🦀, ⛵]

玩家抽到 🐙 → 必須棄到左棄牌堆
```

**兩堆都空**: 玩家可以選擇棄到任一堆

**兩堆都有牌**: 玩家可以選擇棄到任一堆

### 10.2 牌庫重新洗牌

#### 10.2.1 觸發時機
- 玩家嘗試從牌庫抽牌時，牌庫為空

#### 10.2.2 洗牌流程
1. **保留**兩個棄牌堆的**最上方**卡牌（各 1 張）
2. 將其餘棄牌堆的卡牌合併
3. 洗亂合併後的卡牌
4. 成為新的牌庫
5. 兩個棄牌堆只剩各自的最上方卡牌

**範例**:
```
牌庫: 空
左棄牌堆: [🐟, 🦀, ⛵, 🐚, 🐙]
右棄牌堆: [🏊, 🦈, 🐧]

洗牌後:
牌庫: [🐟, 🦀, ⛵, 🐚, 🏊, 🦈]（洗亂）
左棄牌堆: [🐙]（保留最上方）
右棄牌堆: [🐧]（保留最上方）
```

#### 10.2.3 特殊情況

**兩個棄牌堆都只有 1 張或都為空**:
- 無法重新洗牌
- 牌庫維持為空
- 玩家無法從牌庫抽牌（但可以從棄牌堆拿牌）

### 10.3 AI 玩家

#### 10.3.1 AI 難度

**Easy (簡單)**:
- 隨機選擇動作
- 不考慮策略

**Medium (中等)**:
- 基於當前分數決策
- 會嘗試配對有效果的卡牌
- 分數達到一定閾值時宣告

**Hard (困難)**:
- 考慮對手狀態
- 計算最佳配對組合
- 預測對手可能的動作
- 優化宣告時機

#### 10.3.2 AI 決策時間
- 最小延遲: 1 秒
- 最大延遲: 2 秒
- 模擬「思考」過程

### 10.4 斷線處理

#### 10.4.1 玩家斷線
- 玩家標記為「已斷線」
- 座位顯示「離線」標籤
- 該玩家的回合自動跳過

#### 10.4.2 玩家重連
- 玩家標記為「已連線」
- 移除「離線」標籤
- 從下一回合開始正常參與

#### 10.4.3 房主離開
- 如果房主離開，隨機選擇一名在線玩家成為新房主
- 如果所有玩家都離開，房間刪除

---

## 附錄 A: 術語表

| 術語 | 英文 | 定義 |
|-----|------|------|
| 配對效果卡 | Pair Effect Card | 可以進行配對並觸發效果的卡牌 |
| 收集卡 | Collection Card | 根據收集數量計分的卡牌 |
| 倍數卡 | Multiplier Card | 為特定卡牌提供加成的卡牌 |
| 棄牌堆 | Discard Pile | 玩家棄置卡牌的區域 |
| 已打出對子 | Played Pairs | 玩家已配對並打出的卡牌 |
| 宣告 | Declare | 玩家選擇結束回合的方式 |
| 顏色加成 | Color Bonus | 基於最多顏色的額外分數 |

---

## 附錄 B: 快速參考表

### 配對效果速查

| 配對 | 效果代碼 | 效果說明 |
|-----|---------|---------|
| Fish + Fish | draw_blind | 從牌庫抽 1 張 |
| Crab + Crab | draw_discard | 從棄牌堆拿 1 張 |
| Sailboat + Sailboat | extra_turn | 額外回合 |
| Shark + Swimmer | steal_card | 偷對手 1 張牌 |

### 計分公式速查

| 卡牌類型 | 計分公式 |
|---------|---------|
| Shell | (count-1)×2 |
| Octopus | (count-1)×3 |
| Penguin | count×2-1 |
| Sailor | count≥2 ? 5 : 0 |
| Starfish | (count-1)×2 |
| 配對卡 | floor(count/2)×1 |
| Lighthouse | sailboat_count×1 |
| Fish School | fish_count×1 |
| Penguin Colony | penguin_count×2 |
| Captain | sailor_count×3 |
| Seagull | starfish_count×1 |
| Mermaid | 顏色分布計分 |

---

**文件結束**
